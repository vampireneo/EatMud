<!DOCTYPE html>
<html lang="en" manifest="eatmud.appcache" ng-app="eatMudApp">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="apple-touch-icon" href="favicon.ico">
    <link rel="icon" sizes="192x192" href="icon_192x192.png">
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="theme-color" content="#25b7d3">
    <title>食乜好?</title>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!--style>
      #footer {
        margin-top: 60px;
        padding-left: 10px;
        padding-top: 5px;
        padding-bottom: 5px;
      }
      .btn {
        margin-top: 10px;
        margin-bottom: 10px;
      }
    </style-->
    <link rel="stylesheet" href="bower_components/lumx/dist/css/lumx.css">
  </head>
  <body>
    <div class="toolbar bgc-blue-500">
      <div class="toolbar__left mr"></div>
      <span class="toolbar__label fs-title tc-white-1">食乜好?</span>
	  	<div class="toolbar__right"></div>
    </div>

    <div class="grid m">
      <div class="card grid__col12">
        <div class="card__top">
          <strong class="card-title" id="shopName">Loading...</strong>
          <span class="card-subtitle"></span>
        </div>
        <div class="card__content">
          <div class="paragraph">
            <p id="shopAddress"></p>
          </div>
        </div>
        <div class="card__actions m--">
          <button id="suggestButton" class="btn btn--l btn--blue btn--raised" lx-ripple><i class="mdi mdi--repeat"></i> 下個提議</button>
          <button id="whatsappButton" class="btn btn--l btn--green btn--raised" lx-ripple><i class="mdi mdi--share"></i> Whatsapp</button>
          <button id="navButton" class="btn btn--l btn--light-green btn--raised" lx-ripple><i class="mdi mdi--map"></i> Navigation</button>
        </div>
      </div>
      <div class="card grid__col12">
        <div class="card__top">
          <strong class="card-title"></strong>
          <span class="card-subtitle"></span>
        </div>
        <div class="card__content">
          <div class="paragraph">
            <p>Feel free to update the database at <a href="https://docs.google.com/spreadsheets/d/1hlSuO5Fn4bcEcFSrvT9EEQ0GFZ4lpF9tDihUCalgsIU/edit?usp=sharing">Google Drive</a><br/><br/>
          You can add this page in homepage of your mobile as a web app.</p>
          </div>
        </div>
        <div class="card__actions m--">
        </div>
      </div>
    </div>

        <!--div class="row">
          <button type="button"  class="btn btn-primary col-xs-4 col-xs-offset-4 col-sm-3 col-sm-offset-1" data-loading-text="Loading..." autocomplete="off">下個提議</button>
          <a type="button" class="btn btn-success col-xs-4 col-xs-offset-4 col-sm-2 col-sm-offset-1" data-loading-text="Loading..." autocomplete="off" role="button" href="whatsapp://send?text=" data-href="." disabled="disabled">Whatsapp</a>
          <a type="button" class="btn btn-info col-xs-4 col-xs-offset-4 col-sm-3 col-sm-offset-1" data-loading-text="Loading..." autocomplete="off" role="button" href="http://maps.google.com/maps?daddr=" role="button" disabled="disabled">Navigation</a>
        </div-->

    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/velocity/velocity.js"></script>
    <script src="bower_components/moment/min/moment-with-locales.min.js"></script>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/lumx/dist/js/lumx.js"></script>

    <script type="text/javascript">
      angular.module('eatMudApp', ['lumx']);

      var shopData;
      var isLoading = false;
      
      $(document).ready(function() {
        suggest();
      });

      $("#suggestButton").on('click', function () {
        var $btn = $(this);
        suggest();
      });

      function suggest() {
        $("#shopName").text("Loading...");
        $("#shopAddress").text("　");
        shopData = $.parseJSON(localStorage.getItem('shopData'));
        if (shopData != null && shopData.length != undefined && shopData.length > 0) {
          var idx = Math.floor(Math.random()*shopData.length);
          var shopName = shopData[idx].gsx$shop.$t;
          var shopAddress = shopData[idx].gsx$address.$t;
          $("#shopName").text(shopName);
          $("#shopAddress").text(shopAddress);
          $("#whatsappButton").removeAttr("disabled").attr("href", "whatsapp://send?text=" + shopName + ", " + shopAddress);
          $("#navButton").removeAttr("disabled").attr("href", "http://maps.google.com/maps?daddr=" + shopName + " " + shopAddress);
        }
        if (!isLoading) loadData();
      }

      function loadData() {
        isLoading = true;
        $.ajax({
          type: "get",
          async: true,
          url: "https://spreadsheets.google.com/feeds/list/1hlSuO5Fn4bcEcFSrvT9EEQ0GFZ4lpF9tDihUCalgsIU/od6/public/values?alt=json-in-script",
          dataType: "jsonp",//指定以jsonp方式執行
          jsonp: "callback",//"mycallback"會以GET的變數名稱傳送，沒指定時，jQuery使用"callback"當變數名稱
          success: function(data){
            localStorage.setItem('shopData', JSON.stringify(data.feed.entry));
            if ($("#shopName").text() == "Loading...") suggest();
            isLoading = false;
          },
          error: function(){
            if (localStorage.getItem('shopData').length == 0) {
              $("#shopName").text("Unable to load data.");
              $("#shopAddress").text("　");
            }
            isLoading = false;
          }
        });
      }

      // Check if a new cache is available on page load.
      window.addEventListener('load', function(e) {
        window.applicationCache.addEventListener('updateready', function(e) {
          if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
            // Browser downloaded a new app cache.
            if (confirm('A new version of this site is available. Load it?')) {
              window.location.reload();
            }
          } else {
            // Manifest didn't changed. Nothing new to server.
          }
        }, false);
      }, false);
    </script>
  </body>
</html>
